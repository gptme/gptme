id: task-016-preservation-fix
category: feature
difficulty: hard
description: Re-implement code block preservation without duplication
prompt: |
  You are re-implementing the preservation feature for context compression.

  Context: Preservation was disabled due to duplication bugs. Need correct implementation.

  Your task:
  1. Design extraction and re-insertion algorithm
  2. Implement preservation logic without duplication
  3. Test with code-heavy contexts
  4. Verify no content expansion
  5. Re-enable the feature

  Success criteria:
  - Code blocks preserved completely
  - No duplication bugs
  - Tests pass
  - Feature re-enabled

context_files:
  - gptme/context_compression/compressor.py

success_criteria:
  - Preservation code implemented
  - Tests verify no duplication
  - Code blocks preserved correctly
  - Feature flag enabled
  - All tests pass

expected_duration: 50
tags:
  - feature
  - compression
  - preservation
  - bug-fix
